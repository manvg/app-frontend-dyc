<div class="detalle-solicitud-wrapper">
  <div *ngIf="mensajeExito" class="alert-exito">{{ mensajeExito }}</div>
  <div *ngIf="mensajeError" class="alert-error">{{ mensajeError }}</div>

  <div class="volver-right">
    <button class="btn-volver" (click)="volver()">← Volver</button>
  </div>
  <h2 class="detalle-solicitud-title">Detalle de Solicitud</h2>

  <div class="detalle-solicitud-datos">
    <div class="col">
      <div><b>Cliente:</b> {{ solicitud?.nombreCliente }}</div>
      <div><b>Teléfono:</b> {{ solicitud?.telefonoCliente }}</div>
      <div><b>Tipo:</b> {{ solicitud?.nombreTipoSolicitud }}</div>
      <div><b>Observaciones:</b> {{ solicitud?.observaciones }}</div>
    </div>
    <div class="col">
      <div><b>Correo:</b> {{ solicitud?.correoCliente }}</div>
      <div><b>Fecha creación:</b> {{ solicitud?.fechaCreacion | date:'short' }}</div>
      <div><b>Estado:</b> {{ solicitud?.nombreEstadoSolicitud }}</div>
      <div><b>Servicios:</b> {{ solicitud?.nombreServicio || '--' }}</div>
    </div>
  </div>

  <!-- MOSTRAR PRODUCTOS ASOCIADOS SI EXISTEN -->
  <ng-container [ngSwitch]="solicitud?.nombreTipoSolicitud">
    <div *ngSwitchCase="'PRODUCTO'">
      <b>Productos:</b>
      <ng-container *ngIf="productosAsociados.length; else sinProductos">
        <ul class="lista-productos">
          <li *ngFor="let p of productosAsociados">{{ p }}</li>
        </ul>
      </ng-container>
      <ng-template #sinProductos>
        <span>--</span>
      </ng-template>
    </div>
    <div *ngSwitchCase="'SERVICIO'"><b>Servicios:</b> <!-- Lista servicios --></div>
    <div *ngSwitchCase="'PERSONALIZADA'"><b>Detalle personalizado:</b> <!-- Info especial --></div>
  </ng-container>

  <hr>

  <h3>Cambiar Estado</h3>
  <div class="gestion-estado">
    <select [(ngModel)]="estadoNuevo" [disabled]="!solicitud">
      <option *ngFor="let estado of estados" [value]="estado.idEstadoSolicitud">
        {{ estado.nombreEstado }}
      </option>
    </select>
    <input [(ngModel)]="comentario" type="text" maxlength="500" placeholder="Comentario para la bitácora (obligatorio)" [disabled]="!solicitud">
    <button
      (click)="actualizarEstado()"
      [disabled]="loading || !comentario.trim() || !estadoNuevo || !solicitud || estadoNuevo === solicitud?.idEstadoSolicitud">
      Cambiar Estado
    </button>
  </div>

  <hr>

  <h3>Bitácora de Solicitud</h3>

  <button class="btn-agregar-bitacora" (click)="agregandoBitacora = !agregandoBitacora" [disabled]="!solicitud">
    {{ agregandoBitacora ? 'Cancelar' : 'Agregar Bitácora' }}
  </button>

  <div *ngIf="agregandoBitacora" class="form-bitacora">
    <select [(ngModel)]="nuevoEstadoBitacora" [disabled]="!solicitud">
      <option [ngValue]="null" disabled selected>Selecciona estado</option>
      <option *ngFor="let estado of estados" [value]="estado.idEstadoSolicitud">
        {{ estado.nombreEstado }}
      </option>
    </select>
    <input [(ngModel)]="nuevaDescripcionBitacora" type="text" maxlength="500" placeholder="Descripción (obligatorio)" [disabled]="!solicitud">
    <button (click)="agregarBitacora()" [disabled]="!solicitud">Guardar Bitácora</button>
  </div>

  <table class="tabla-bitacora">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Estado</th>
        <th>Descripción</th>
        <th>Usuario</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let b of bitacoras">
        <td>{{ b.fechaCreacion | date:'short' }}</td>
        <td>{{ b.nombreEstado }}</td>
        <td>{{ b.descripcion }}</td>
        <td>{{ b.usuarioCreacion }}</td>
      </tr>
      <tr *ngIf="bitacoras.length === 0">
        <td colspan="4">Sin registros de bitácora.</td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <span>Cargando...</span>
  </div>
</div>

<div *ngIf="!solicitud && !loading">
  <p>Cargando datos de la solicitud...</p>
</div>
